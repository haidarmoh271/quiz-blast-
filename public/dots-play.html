<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Ø¨ÙŠØª Ø¨ÙŠÙˆØª â€” Ø§Ù†Ø¶Ù…</title>
<script src="/socket.io/socket.io.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&family=Oswald:wght@700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Tajawal',sans-serif;background:#111;color:#fff;min-height:100vh;display:flex;flex-direction:column;}
.topbar{background:#1a1a1a;border-bottom:1px solid #222;padding:0.8rem 1.5rem;display:flex;align-items:center;gap:1rem;}
.topbar a{color:#888;text-decoration:none;}
.topbar-brand{font-family:'Oswald',sans-serif;font-size:1rem;letter-spacing:0.2em;}
.main{flex:1;display:flex;align-items:center;justify-content:center;padding:1.5rem;}
.card{background:#1a1a1a;border:1px solid #2a2a2a;border-radius:4px;padding:2rem;width:100%;max-width:380px;text-align:center;}
.card-title{font-family:'Oswald',sans-serif;font-size:1.2rem;letter-spacing:0.2em;margin-bottom:1.5rem;}
input{width:100%;padding:0.9rem;border:1px solid #333;background:#111;color:#fff;border-radius:2px;font-family:'Tajawal',sans-serif;font-size:1.1rem;outline:none;margin-bottom:0.8rem;text-align:center;}
input:focus{border-color:#fff;}
.btn{width:100%;padding:0.9rem;border:none;border-radius:2px;font-size:1rem;font-family:'Tajawal',sans-serif;font-weight:700;cursor:pointer;letter-spacing:0.15em;}
.btn-join{background:#fff;color:#111;}
.team-btns{display:grid;grid-template-columns:1fr 1fr;gap:0.8rem;margin-bottom:0.8rem;}
.team-btn{padding:1rem;border-radius:3px;border:2px solid transparent;cursor:pointer;font-family:'Tajawal',sans-serif;font-size:0.95rem;font-weight:700;transition:all 0.15s;}

/* Waiting */
#waiting{display:none;text-align:center;}
.player-name-big{font-family:'Oswald',sans-serif;font-size:1.8rem;letter-spacing:0.15em;margin:0.5rem 0;}
.team-badge{font-size:0.85rem;letter-spacing:0.2em;padding:0.3rem 1rem;border-radius:20px;display:inline-block;margin-bottom:1rem;}
.pulse-ring{width:50px;height:50px;border-radius:50%;border:2px solid #fff;margin:1.5rem auto;animation:ring 1.5s infinite;}
@keyframes ring{0%{transform:scale(1);opacity:1;}100%{transform:scale(2.5);opacity:0;}}
.waiting-text{color:#666;font-size:0.85rem;letter-spacing:0.2em;text-transform:uppercase;}

/* Question */
#question{display:none;}
.q-header{background:#1a1a1a;border-bottom:1px solid #222;padding:0.8rem 1.5rem;text-align:center;position:sticky;top:0;z-index:10;}
.q-counter{font-size:0.78rem;letter-spacing:0.2em;color:#666;text-transform:uppercase;}
.timer-bar{height:4px;background:#222;margin-top:0.5rem;}
.timer-fill{height:100%;background:#fff;transition:width 1s linear;}
.q-text{padding:1.5rem;font-size:1.2rem;font-weight:700;text-align:center;background:#1a1a1a;border-bottom:1px solid #222;min-height:70px;display:flex;align-items:center;justify-content:center;}
.answer-btns{display:grid;grid-template-columns:1fr 1fr;gap:2px;background:#111;height:calc(100vh - 155px);}
.ans-btn{border:none;cursor:pointer;font-size:1rem;font-family:'Tajawal',sans-serif;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;gap:0.4rem;padding:1rem;text-align:center;}
.ans-btn:active{filter:brightness(0.7);}
@keyframes correctBurst{0%{transform:scale(1);}30%{transform:scale(1.08);}100%{transform:scale(1);}}
@keyframes wrongShake{0%,100%{transform:translateX(0);}20%{transform:translateX(-8px);}40%{transform:translateX(8px);}60%{transform:translateX(-6px);}80%{transform:translateX(6px);}}
.ans-correct{animation:correctBurst 0.5s ease forwards !important;background:#22c55e !important;}
.ans-wrong{animation:wrongShake 0.5s ease forwards !important;background:#ef4444 !important;}

/* Result */
#answerResult{display:none;position:fixed;inset:0;background:#111;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:2rem;z-index:100;}
.result-icon{font-size:4rem;animation:pop 0.4s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes pop{from{transform:scale(0);}to{transform:scale(1);}}
.result-text{font-family:'Oswald',sans-serif;font-size:1.8rem;letter-spacing:0.15em;margin:0.8rem 0;}
.result-points{font-size:1rem;color:#aaa;font-weight:700;}

/* Line select â€” for leader of winning team */
#lineSelect{display:none;position:fixed;inset:0;background:#111;z-index:150;flex-direction:column;align-items:center;justify-content:center;padding:1.5rem;}
.line-title{font-family:'Oswald',sans-serif;font-size:1.1rem;letter-spacing:0.2em;margin-bottom:0.5rem;}
.line-sub{font-size:0.78rem;color:#666;letter-spacing:0.15em;margin-bottom:1.5rem;}
#lineCanvas{border-radius:4px;touch-action:none;}

/* Leaderboard */
#lbUpdate{display:none;position:fixed;inset:0;background:#111;align-items:flex-start;justify-content:center;padding:2rem;overflow-y:auto;z-index:100;flex-direction:column;}
.lb-title{font-family:'Oswald',sans-serif;font-size:1.1rem;letter-spacing:0.3em;text-align:center;margin-bottom:1rem;color:#fff;width:100%;}
.lb-row{display:flex;align-items:center;gap:1rem;background:#1a1a1a;border:1px solid #2a2a2a;padding:0.7rem 1rem;margin-bottom:0.4rem;max-width:400px;width:100%;}

/* Final */
#playerFinal{display:none;text-align:center;padding:2rem;}
.final-icon{font-size:4rem;margin-bottom:1rem;}
.final-msg{font-family:'Oswald',sans-serif;font-size:1.5rem;letter-spacing:0.15em;}

/* Toast */
.toast{position:fixed;top:1rem;left:50%;transform:translateX(-50%);background:#fff;color:#111;padding:0.7rem 1.2rem;border-radius:2px;font-size:0.9rem;z-index:9999;animation:fadeOut 3s forwards;}
@keyframes fadeOut{0%{opacity:0;}10%{opacity:1;}80%{opacity:1;}100%{opacity:0;}}
/* Countdown */
#countdown{display:none;position:fixed;inset:0;background:#0a0a0a;z-index:200;flex-direction:column;align-items:center;justify-content:center;}
#countdown.active{display:flex;}
.countdown-num{font-family:'Oswald',sans-serif;font-size:10rem;font-weight:700;color:#fff;animation:countPop 0.8s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes countPop{0%{transform:scale(2);opacity:0;}100%{transform:scale(1);opacity:1;}}
.countdown-label{font-size:1rem;letter-spacing:0.4em;color:#555;text-transform:uppercase;margin-top:1rem;}
</style>
</head>
<body>

<div id="countdown"><div class="countdown-num" id="countNum">3</div><div class="countdown-label">Ø§Ø³ØªØ¹Ø¯!</div></div>

<div class="topbar">
  <a href="/">â†</a>
  <div class="topbar-brand">ğŸ”´ Ø¨ÙŠØª Ø¨ÙŠÙˆØª</div>
</div>

<!-- Join -->
<div class="main" id="joinScreen">
  <div class="card">
    <div class="card-title">Ø§Ù†Ø¶Ù… Ù„Ù„Ø¹Ø¨Ø©</div>
    <input type="text" id="codeInput" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù„Ø¹Ø¨Ø©" maxlength="6"
      oninput="this.value=this.value.replace(/\D/g,'')"
      onkeydown="if(event.key==='Enter')tryJoin()"/>
    <input type="text" id="nameInput" placeholder="Ø§Ø³Ù…Ùƒ" maxlength="20"
      onkeydown="if(event.key==='Enter')tryJoin()"/>
    <p style="font-size:0.75rem;letter-spacing:0.2em;color:#555;margin-bottom:0.8rem;text-transform:uppercase">Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</p>
    <div class="team-btns">
      <button class="team-btn" id="btn-red" onclick="selectTeam('red')"
        style="background:rgba(239,68,68,0.15);border-color:#ef444433;color:#ef4444">ğŸ”´ Ø§Ù„Ø£Ø­Ù…Ø±</button>
      <button class="team-btn" id="btn-blue" onclick="selectTeam('blue')"
        style="background:rgba(59,130,246,0.15);border-color:#3b82f633;color:#3b82f6">ğŸ”µ Ø§Ù„Ø£Ø²Ø±Ù‚</button>
    </div>
    <div style="background:#1a1a1a;border:1px solid #2a2a2a;border-radius:3px;padding:0.8rem;margin-bottom:0.8rem;">
      <p style="font-size:0.72rem;letter-spacing:0.2em;color:#555;text-transform:uppercase;margin-bottom:0.6rem">Ø¯ÙˆØ±Ùƒ ÙÙŠ Ø§Ù„ÙØ±ÙŠÙ‚</p>
      <div style="display:flex;gap:0.5rem">
        <button id="role-leader" onclick="selectRole('leader')"
          style="flex:1;padding:0.6rem;border:1px solid #fff;background:#fff;color:#111;border-radius:2px;cursor:pointer;font-family:Tajawal,sans-serif;font-size:0.9rem;font-weight:700;transition:all 0.15s">
          ğŸ‘‘ Ù‚Ø§Ø¦Ø¯
        </button>
        <button id="role-member" onclick="selectRole('member')"
          style="flex:1;padding:0.6rem;border:1px solid #333;background:transparent;color:#fff;border-radius:2px;cursor:pointer;font-family:Tajawal,sans-serif;font-size:0.9rem;transition:all 0.15s">
          ğŸ‘¤ Ø¹Ø¶Ùˆ
        </button>
      </div>
      <p id="roleHint" style="font-size:0.7rem;color:#555;margin-top:0.5rem">Ø§Ù„Ù‚Ø§Ø¦Ø¯ ÙŠØ±Ø³Ù… Ø§Ù„Ø®Ø· Ø¹Ù†Ø¯ Ø§Ù„ÙÙˆØ²</p>
    </div>
    <button class="btn btn-join" onclick="tryJoin()">Ø¯Ø®ÙˆÙ„ â–¶</button>
  </div>
</div>

<!-- Waiting -->
<div class="main" id="waiting">
  <div>
    <div style="font-size:2.5rem;text-align:center">ğŸ®</div>
    <div class="player-name-big" id="myNameDisplay"></div>
    <div class="team-badge" id="myTeamBadge"></div>
    <div class="pulse-ring"></div>
    <div class="waiting-text">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</div>
    <div id="waitingPlayers"></div>
  </div>
</div>

<!-- Question -->
<div id="question">
  <div class="q-header">
    <div class="q-counter" id="qCounterP">Ø³Ø¤Ø§Ù„ 1</div>
    <div class="timer-bar"><div class="timer-fill" id="timerFill" style="width:100%"></div></div>
  </div>
  <div class="q-text" id="qTextP">...</div>
  <div class="answer-btns" id="answerBtns"></div>
</div>

<!-- Answer Result -->
<div id="answerResult">
  <div class="result-icon" id="resultIcon">âœ…</div>
  <div class="result-text" id="resultText">Ø£Ø­Ø³Ù†Øª!</div>
  <div class="result-points" id="resultPoints">+500 Ù†Ù‚Ø·Ø©</div>
</div>

<!-- Line Select (for leader of winning team) -->
<div id="lineSelect">
  <div class="line-title" id="lineSelectTitle">Ø§Ø®ØªØ± Ø®Ø·Ø§Ù‹!</div>
  <div class="line-sub">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ† Ù„Ø±Ø³Ù… Ø®Ø·</div>
  <canvas id="lineCanvas"></canvas>
  <p style="font-size:0.75rem;color:#555;margin-top:1rem;letter-spacing:0.15em">Ø§Ø®ØªØ± Ø¨Ø­ÙƒÙ…Ø© ğŸ¯</p>
</div>

<!-- Leaderboard -->
<div id="lbUpdate" style="flex-direction:column;align-items:center">
  <div class="lb-title">// Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
  <div id="lbList"></div>
</div>

<!-- Final -->
<div id="playerFinal">
  <div class="final-icon" id="finalIcon">ğŸ†</div>
  <div class="final-msg" id="finalMsg"></div>
  <div id="finalScore" style="font-size:1.2rem;color:#aaa;margin-top:0.5rem"></div>
  <button class="btn btn-join" style="margin-top:2rem;max-width:300px;display:inline-block" onclick="location.href='/'">â–¶ Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
</div>

<script>
const socket = io();
const COLORS = ['#ccc','#1a1a1a','#444','#222'];
const SYMBOLS = ['â–²','â™¦','â—','â˜…'];
let myCode=null, myName=null, myTeam=null, myRole='leader';
let isLeader=false, answered=false, selectedAnswer=-1, maxTime=20;
let timerInterval=null, audioCtx=null;
let gridSize=5, boardLines={}, boardBoxes={};

// URL params
window.addEventListener('DOMContentLoaded',()=>{
  const params=new URLSearchParams(window.location.search);
  const code=params.get('code');
  if(code){
    document.getElementById('codeInput').value=code;
    document.getElementById('codeInput').style.display='none';
    setTimeout(()=>document.getElementById('nameInput').focus(),300);
  }
});

function selectTeam(t){
  myTeam=t;
  document.getElementById('btn-red').style.borderColor = t==='red'?'#ef4444':'#ef444433';
  document.getElementById('btn-red').style.background = t==='red'?'rgba(239,68,68,0.4)':'rgba(239,68,68,0.15)';
  document.getElementById('btn-blue').style.borderColor = t==='blue'?'#3b82f6':'#3b82f633';
  document.getElementById('btn-blue').style.background = t==='blue'?'rgba(59,130,246,0.4)':'rgba(59,130,246,0.15)';
}

function selectRole(role){
  myRole = role;
  const isLeader = role==='leader';
  document.getElementById('role-leader').style.background = isLeader?'#fff':'transparent';
  document.getElementById('role-leader').style.color = isLeader?'#111':'#fff';
  document.getElementById('role-leader').style.borderColor = isLeader?'#fff':'#333';
  document.getElementById('role-member').style.background = !isLeader?'#fff':'transparent';
  document.getElementById('role-member').style.color = !isLeader?'#111':'#fff';
  document.getElementById('role-member').style.borderColor = !isLeader?'#fff':'#333';
  document.getElementById('roleHint').textContent = isLeader
    ? 'Ø§Ù„Ù‚Ø§Ø¦Ø¯ ÙŠØ±Ø³Ù… Ø§Ù„Ø®Ø· Ø¹Ù†Ø¯ Ø§Ù„ÙÙˆØ²'
    : 'Ø§Ù„Ø¹Ø¶Ùˆ ÙŠØ¬Ø§ÙˆØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙ‚Ø·';
}

function tryJoin(){
  const code=document.getElementById('codeInput').value.trim();
  const name=document.getElementById('nameInput').value.trim();
  const codeVisible=document.getElementById('codeInput').style.display!=='none';
  if(codeVisible&&code.length<6){toast('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯');return;}
  if(!code){toast('Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­');return;}
  if(!name){toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ');return;}
  if(!myTeam){toast('Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ Ø£ÙˆÙ„Ø§Ù‹');return;}
  myCode=code; myName=name;
  socket.emit('dots:join',{code,name,team:myTeam,wantLeader:myRole==='leader'});
}

socket.on('dots:joined',({name,team,isLeader:il,gridSize:gs})=>{
  isLeader=il; gridSize=gs;
  hideAll();
  document.querySelector('.main#waiting').style.display='flex';
  document.getElementById('myNameDisplay').textContent=name+(il?' ğŸ‘‘':'');
  const badge=document.getElementById('myTeamBadge');
  if(team==='red'){badge.textContent='ğŸ”´ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±';badge.style.background='rgba(239,68,68,0.2)';badge.style.color='#ef4444';}
  else{badge.textContent='ğŸ”µ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚';badge.style.background='rgba(59,130,246,0.2)';badge.style.color='#3b82f6';}
});

socket.on('dots:playerList',({players})=>{
  const red = players.filter(p=>p.team==='red');
  const blue = players.filter(p=>p.team==='blue');
  // update waiting screen team counts
  const badge = document.getElementById('myTeamBadge');
  if(badge && myTeam){
    const myCount = myTeam==='red' ? red.length : blue.length;
    const emoji = myTeam==='red' ? 'ğŸ”´' : 'ğŸ”µ';
    const name = myTeam==='red' ? 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚';
    badge.textContent = `${emoji} ${name} (${myCount}/2)`;
  }
  // show all players in waiting
  const waitingEl = document.getElementById('waitingPlayers');
  if(waitingEl){
    waitingEl.innerHTML = `
      <div style="margin-top:1rem;text-align:right">
        <div style="color:#ef4444;font-size:0.75rem;letter-spacing:0.2em;margin-bottom:0.3rem">ğŸ”´ ${red.map(p=>p.name+(p.isLeader?' ğŸ‘‘':'')).join(' Â· ')||'...'}</div>
        <div style="color:#3b82f6;font-size:0.75rem;letter-spacing:0.2em">ğŸ”µ ${blue.map(p=>p.name+(p.isLeader?' ğŸ‘‘':'')).join(' Â· ')||'...'}</div>
      </div>`;
  }
});

socket.on('error',(msg)=>toast(msg));
socket.on('dots:youAreLeader',()=>{
  isLeader=true;
  const nameEl=document.getElementById('myNameDisplay');
  if(nameEl && !nameEl.textContent.includes('ğŸ‘‘')) nameEl.textContent+=' ğŸ‘‘';
  toast('Ø£ØµØ¨Ø­Øª Ù‚Ø§Ø¦Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚! ğŸ‘‘');
});

socket.on('dots:kicked',()=>{alert('ØªÙ… Ø¥Ø®Ø±Ø§Ø¬Ùƒ');location.href='/';});

socket.on('dots:question',({index,total,question,answers,time})=>{
  answered=false; selectedAnswer=-1; maxTime=time;
  hideAll();
  document.getElementById('qCounterP').textContent=`Ø³Ø¤Ø§Ù„ ${index+1} / ${total}`;
  document.getElementById('qTextP').textContent=question;
  document.getElementById('answerBtns').innerHTML=answers.map((a,i)=>`
    <button class="ans-btn" style="background:${COLORS[i]}" onclick="sendAnswer(${i})">
      <span>${SYMBOLS[i]}</span><span>${a}</span>
    </button>`).join('');

  // countdown 3-2-1
  const cd=document.getElementById('countdown');
  const cdNum=document.getElementById('countNum');
  let count=3; cdNum.textContent=count; cd.classList.add('active');
  const cdInt=setInterval(()=>{
    count--;
    if(count<=0){
      clearInterval(cdInt); cd.classList.remove('active');
      document.getElementById('question').style.display='block';
      clearInterval(timerInterval);
      let t=time;
      const fill=document.getElementById('timerFill');
      fill.style.transition='none'; fill.style.width='100%';
      setTimeout(()=>{fill.style.transition=`width ${time}s linear`;fill.style.width='0%';},50);
      timerInterval=setInterval(()=>{
        t--;
        if(t<=5&&t>0) playTick(t===1);
        if(t<=0) clearInterval(timerInterval);
      },1000);
    } else {
      cdNum.textContent=count;
      cdNum.style.animation='none'; void cdNum.offsetWidth;
      cdNum.style.animation='countPop 0.8s cubic-bezier(0.34,1.56,0.64,1)';
    }
  },900);
});

function sendAnswer(i){
  if(answered) return;
  answered=true; selectedAnswer=i;
  document.querySelectorAll('.ans-btn').forEach((b,idx)=>{
    b.onclick=null;
    if(idx===i){b.style.opacity='1';b.style.border='3px solid #fff';}
    else b.style.opacity='0.35';
  });
  const pct=parseFloat(document.getElementById('timerFill').style.width)||0;
  socket.emit('dots:answer',{code:myCode,answerIndex:i,timeLeft:pct/100*maxTime});
}

socket.on('dots:answerResult',({correct,points})=>{
  document.querySelectorAll('.ans-btn').forEach((b,idx)=>{
    b.onclick=null;
    if(idx===selectedAnswer) b.classList.add(correct?'ans-correct':'ans-wrong');
    else b.style.opacity='0.2';
  });
  setTimeout(()=>{
    document.getElementById('answerResult').style.display='flex';
    document.getElementById('resultIcon').textContent=correct?'âœ…':'âŒ';
    document.getElementById('resultText').textContent=correct?'Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! ğŸ‰':'Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© ğŸ˜”';
    document.getElementById('resultPoints').textContent=correct?`+${points} Ù†Ù‚Ø·Ø©`:'0 Ù†Ù‚Ø·Ø©';
    if(correct) launchConfetti();
  },800);
});

// Line drawing for leader of winning team
socket.on('dots:canDrawLine',({team, gridSize:gs})=>{
  if(myTeam!==team||!isLeader) return;
  gridSize=gs;
  showLineSelect();
});

function showLineSelect(){
  document.getElementById('lineSelect').style.display='flex';
  document.getElementById('lineSelectTitle').textContent=
    myTeam==='red'?'ğŸ”´ Ø§Ø®ØªØ± Ø®Ø·Ùƒ!':'ğŸ”µ Ø§Ø®ØªØ± Ø®Ø·Ùƒ!';
  const canvas=document.getElementById('lineCanvas');
  const size=Math.min(320,window.innerWidth-60);
  canvas.width=size; canvas.height=size;
  drawLineCanvas(canvas);
  setupLineTouch(canvas);
}

function drawLineCanvas(canvas){
  const ctx=canvas.getContext('2d');
  const n=gridSize, pad=20, step=(canvas.width-pad*2)/(n-1);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // draw existing lines
  Object.entries(boardLines).forEach(([key,team])=>{
    const color=team==='red'?'#ef4444':'#3b82f6';
    const parts=key.split('_'); const type=parts[0],r=+parts[1],c=+parts[2];
    ctx.strokeStyle=color; ctx.lineWidth=3; ctx.beginPath();
    if(type==='h'){ctx.moveTo(pad+c*step,pad+r*step);ctx.lineTo(pad+(c+1)*step,pad+r*step);}
    else{ctx.moveTo(pad+c*step,pad+r*step);ctx.lineTo(pad+c*step,pad+(r+1)*step);}
    ctx.stroke();
  });
  // boxes
  Object.entries(boardBoxes).forEach(([key,team])=>{
    const[r,c]=key.split('_').map(Number);
    ctx.fillStyle=team==='red'?'rgba(239,68,68,0.2)':'rgba(59,130,246,0.2)';
    ctx.fillRect(pad+c*step+2,pad+r*step+2,step-4,step-4);
  });
  // dots
  for(let r=0;r<n;r++) for(let c=0;c<n;c++){
    ctx.fillStyle='#fff'; ctx.beginPath();
    ctx.arc(pad+c*step,pad+r*step,4,0,Math.PI*2); ctx.fill();
  }
}

function setupLineTouch(canvas){
  const n=gridSize, pad=20, step=(canvas.width-pad*2)/(n-1);
  function getHit(x,y){
    // check horizontal lines
    for(let r=0;r<n;r++) for(let c=0;c<n-1;c++){
      const mx=pad+c*step+step/2, my=pad+r*step;
      if(Math.abs(x-mx)<step*0.45&&Math.abs(y-my)<12){
        const key=`h_${r}_${c}`;
        if(!boardLines[key]) return key;
      }
    }
    // check vertical lines
    for(let r=0;r<n-1;r++) for(let c=0;c<n;c++){
      const mx=pad+c*step, my=pad+r*step+step/2;
      if(Math.abs(x-mx)<12&&Math.abs(y-my)<step*0.45){
        const key=`v_${r}_${c}`;
        if(!boardLines[key]) return key;
      }
    }
    return null;
  }
  function handleClick(e){
    e.preventDefault();
    const rect=canvas.getBoundingClientRect();
    const cx=e.touches?e.touches[0].clientX:e.clientX;
    const cy=e.touches?e.touches[0].clientY:e.clientY;
    const x=(cx-rect.left)*(canvas.width/rect.width);
    const y=(cy-rect.top)*(canvas.height/rect.height);
    const key=getHit(x,y);
    if(key){
      socket.emit('dots:drawLine',{code:myCode,lineKey:key});
      document.getElementById('lineSelect').style.display='none';
    }
  }
  canvas.addEventListener('click',handleClick);
  canvas.addEventListener('touchstart',handleClick,{passive:false});
}

socket.on('dots:lineDrawn',({lineKey,team,newBoxes})=>{
  boardLines[lineKey]=team;
  newBoxes.forEach(k=>boardBoxes[k]=team);
});

socket.on('dots:results',({leaderboard,scores,winTeam,winName,canDrawLine})=>{
  document.getElementById('answerResult').style.display='none';
  document.getElementById('question').style.display='none';
  const el=document.getElementById('lbUpdate');
  el.style.display='flex';
  const winColor = winTeam==='red'?'#ef4444':winTeam==='blue'?'#3b82f6':'#888';
  const winEmoji = winTeam==='red'?'ğŸ”´':winTeam==='blue'?'ğŸ”µ':'ğŸ¤';
  document.getElementById('lbList').innerHTML=`
    ${winName ? `<div style="text-align:center;margin-bottom:1rem;padding:0.8rem;background:rgba(255,255,255,0.05);border-radius:3px;border:1px solid ${winColor}33">
      <div style="font-size:0.7rem;color:#666;letter-spacing:0.2em;margin-bottom:0.3rem">Ø£Ø³Ø±Ø¹ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âš¡</div>
      <div style="font-size:1.2rem;font-weight:900;color:${winColor}">${winEmoji} ${winName}</div>
      ${canDrawLine?'<div style="font-size:0.7rem;color:#666;margin-top:0.3rem">ÙŠØ±Ø³Ù… Ø®Ø·Ø§Ù‹ Ø§Ù„Ø¢Ù†...</div>':''}
    </div>` : '<div style="text-align:center;color:#666;margin-bottom:1rem;font-size:0.85rem">Ù„Ø§ Ø£Ø­Ø¯ Ø£Ø¬Ø§Ø¨ ØµØ­ ğŸ˜”</div>'}
    <div style="display:flex;gap:2rem;justify-content:center;margin-bottom:1rem">
      <div style="text-align:center"><div style="font-size:1.8rem;font-weight:900;color:#ef4444">${scores.red}</div><div style="font-size:0.7rem;color:#888">ğŸ”´ Ø¨ÙŠÙˆØª Ø§Ù„Ø£Ø­Ù…Ø±</div></div>
      <div style="text-align:center"><div style="font-size:1.8rem;font-weight:900;color:#3b82f6">${scores.blue}</div><div style="font-size:0.7rem;color:#888">ğŸ”µ Ø¨ÙŠÙˆØª Ø§Ù„Ø£Ø²Ø±Ù‚</div></div>
    </div>
    ${leaderboard.map((p,i)=>`
      <div class="lb-row">
        <span>${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]||'#'+(i+1)}</span>
        <span style="flex:1">${p.name}</span>
        <span style="font-weight:900">${p.score}</span>
      </div>`).join('')}`;
});

socket.on('dots:gameEnd',({winner,scores})=>{
  hideAll();
  document.getElementById('playerFinal').style.display='block';
  const icons={red:'ğŸ”´',blue:'ğŸ”µ',tie:'ğŸ¤'};
  const names={red:'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø± ÙØ§Ø²!',blue:'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚ ÙØ§Ø²!',tie:'ØªØ¹Ø§Ø¯Ù„!'};
  const myWon=(winner===myTeam);
  document.getElementById('finalIcon').textContent=myWon?'ğŸ†':(winner==='tie'?'ğŸ¤':'ğŸ˜”');
  document.getElementById('finalMsg').textContent=names[winner]||'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©';
  document.getElementById('finalScore').textContent=`ğŸ”´ ${scores.red} Ø¨ÙŠØª  â€”  ğŸ”µ ${scores.blue} Ø¨ÙŠØª`;
});

// confetti
function launchConfetti(){
  const colors=['#ef4444','#3b82f6','#fff','#ffd700'];
  for(let i=0;i<50;i++){
    const el=document.createElement('div');
    el.style.cssText=`position:fixed;width:8px;height:8px;top:-10px;border-radius:2px;pointer-events:none;z-index:400;left:${Math.random()*100}vw;background:${colors[Math.floor(Math.random()*colors.length)]};animation:confettiFall ${1.5+Math.random()*2}s linear forwards ${Math.random()*0.5}s`;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),3500);
  }
}

function playTick(isLast){
  try{
    if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    const osc=audioCtx.createOscillator(),gain=audioCtx.createGain();
    osc.connect(gain);gain.connect(audioCtx.destination);
    osc.frequency.value=isLast?880:660;osc.type='sine';
    gain.gain.setValueAtTime(0.4,audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.1);
    osc.start(audioCtx.currentTime);osc.stop(audioCtx.currentTime+0.1);
  }catch(e){}
}

function hideAll(){
  document.getElementById('countdown').classList.remove('active');
  ['joinScreen','waiting','question','answerResult','lbUpdate','playerFinal','lineSelect'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.display='none';
  });
}

function toast(msg){
  const el=document.createElement('div');
  el.className='toast';el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),3100);
}
</script>
<style>@keyframes confettiFall{0%{transform:translateY(0) rotate(0deg);opacity:1;}100%{transform:translateY(110vh) rotate(720deg);opacity:0;}}</style>
</body>
</html>
