<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø© - QuizBlast</title>
<meta name="theme-color" content="#e94560"/>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ®</text></svg>"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="QuizBlast"/>
<script>
  if('serviceWorker' in navigator){
      }
</script>
<script src="/socket.io/socket.io.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Tajawal',sans-serif;
  min-height:100vh;
  background:#111;
  color:#fff;
}
.topbar{
  background:rgba(255,255,255,0.05);
  padding:1rem 2rem;
  display:flex;align-items:center;gap:1rem;
}
.topbar a{color:#888;text-decoration:none;font-size:1.3rem;}
.topbar h1{font-size:1.4rem;font-weight:900;
  background:#fff;
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}

.main{max-width:900px;margin:0 auto;padding:2rem;}

/* â”€â”€ Builder â”€â”€ */
#builder .quiz-title-wrap{
  background:rgba(255,255,255,0.05);
  border-radius:16px;padding:1.5rem;margin-bottom:1.5rem;
}
.label{color:#888;font-size:0.9rem;margin-bottom:0.4rem;display:block;}
input,textarea{
  width:100%;padding:0.8rem 1rem;border-radius:10px;
  border:2px solid rgba(255,255,255,0.15);
  background:rgba(255,255,255,0.05);color:#fff;
  font-size:1rem;font-family:'Tajawal',sans-serif;
  outline:none;margin-bottom:0.8rem;
}
input:focus,textarea:focus{border-color:#fff;}

.question-card{
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:16px;padding:1.5rem;
  margin-bottom:1rem;position:relative;
}
.question-card .q-header{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;
}
.q-num{
  background:#fff;color:#fff;
  border-radius:50%;width:32px;height:32px;
  display:flex;align-items:center;justify-content:center;font-weight:700;
  font-size:0.9rem;
}
.del-btn{
  background:rgba(233,69,96,0.2);border:1px solid #e94560;
  color:#fff;border-radius:8px;padding:0.3rem 0.8rem;
  cursor:pointer;font-size:0.85rem;font-family:'Tajawal',sans-serif;
  transition:all 0.2s;
}
.del-btn:hover{background:#fff;color:#fff;}

.answers-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:0.7rem;
}
.answer-wrap{
  display:flex;align-items:center;gap:0.5rem;
}
.answer-wrap input[type=text]{margin:0;flex:1;}
.correct-radio{
  width:20px;height:20px;accent-color:#0f9b8e;cursor:pointer;
  flex-shrink:0;
}
.answer-colors{
  width:12px;height:12px;border-radius:3px;flex-shrink:0;
}

.time-wrap{display:flex;align-items:center;gap:0.5rem;margin-top:0.8rem;}
.time-wrap label{color:#888;font-size:0.9rem;white-space:nowrap;}
.time-wrap select{
  padding:0.4rem 0.8rem;border-radius:8px;
  background:rgba(255,255,255,0.1);color:#fff;
  border:1px solid rgba(255,255,255,0.2);
  font-family:'Tajawal',sans-serif;width:auto;
}

.btn{
  padding:0.9rem 2rem;border:none;border-radius:12px;
  font-size:1rem;font-family:'Tajawal',sans-serif;font-weight:700;
  cursor:pointer;transition:all 0.2s;
}
.btn-add{background:rgba(255,255,255,0.1);color:#fff;width:100%;}
.btn-add:hover{background:rgba(255,255,255,0.2);}
.btn-create{
  background:#e94560;
  color:#fff;width:100%;margin-top:1rem;font-size:1.1rem;border:none;border-radius:4px;padding:1rem;cursor:pointer;font-family:'Tajawal',sans-serif;font-weight:700;letter-spacing:0.1em;
}
.btn-create:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(233,69,96,0.4);}

/* â”€â”€ Lobby â”€â”€ */
#lobby{display:none;text-align:center;}
.code-display{
  background:linear-gradient(135deg,#fff,#aaa);
  border-radius:20px;padding:2rem;margin:2rem 0;
}
.code-display p{font-size:1rem;margin-bottom:0.5rem;opacity:0.9;}
.code-big{font-size:4rem;font-weight:900;letter-spacing:0.3rem;}

.players-grid{
  display:flex;flex-wrap:wrap;gap:0.7rem;justify-content:center;
  min-height:80px;margin:1rem 0;
}
.player-chip{
  background:#1a1a1a;
  border:1px solid rgba(255,255,255,0.2);
  border-radius:20px;padding:0.5rem 1.2rem;
  font-size:0.95rem;animation:popIn 0.3s ease;
}
@keyframes popIn{from{transform:scale(0.5);opacity:0;}to{transform:scale(1);opacity:1;}}

.btn-start{
  background:#aaa;
  color:#fff;font-size:1.2rem;padding:1rem 3rem;
}
.btn-start:disabled{opacity:0.4;cursor:not-allowed;transform:none!important;}

/* â”€â”€ Game Screen â”€â”€ */
#gamescreen{display:none;}
.progress-bar{
  height:6px;background:rgba(255,255,255,0.1);
}
.progress-fill{
  height:100%;background:#fff;
  transition:width 0.3s;
}
.game-container{max-width:900px;margin:0 auto;padding:2rem;}
.question-header{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;
}
.q-counter{color:#888;font-size:0.9rem;}
.timer-circle{
  width:70px;height:70px;border-radius:50%;
  border:4px solid #e94560;
  display:flex;align-items:center;justify-content:center;
  font-size:1.6rem;font-weight:900;
  transition:color 0.3s,border-color 0.3s;
}
.question-box{
  background:rgba(255,255,255,0.1);
  border-radius:16px;padding:2rem;
  font-size:1.5rem;font-weight:700;
  text-align:center;margin-bottom:1.5rem;
  min-height:100px;display:flex;align-items:center;justify-content:center;
}
.q-image{max-width:100%;border-radius:12px;margin-bottom:1rem;max-height:200px;object-fit:cover;}

.answers-host{
  display:grid;grid-template-columns:1fr 1fr;gap:1rem;
}
.ans-card{
  border-radius:14px;padding:1.2rem;
  font-size:1rem;font-weight:700;text-align:center;
  display:flex;align-items:center;gap:0.8rem;
}
.ans-colors{
  background:var(--c);
}
.ans-symbol{font-size:1.5rem;}
.ans-text{flex:1;}
.ans-count{
  background:rgba(255,255,255,0.05);
  border-radius:20px;padding:0.2rem 0.7rem;font-size:0.85rem;
}

.answered-info{
  text-align:center;color:#888;margin:1rem 0;
}
.btn-next{
  background:#aaa;
  color:#fff;width:100%;font-size:1.1rem;margin-top:1rem;
}

/* â”€â”€ Results â”€â”€ */
.results-overlay{
  background:#1a1a1a;border:1px solid #2a2a2a;
  padding:2rem;border-radius:4px;margin-top:1rem;
}
.answer-bars{display:flex;gap:0.5rem;align-items:flex-end;height:120px;justify-content:center;}
.bar-wrap{display:flex;flex-direction:column;align-items:center;gap:0.3rem;}
.bar{
  width:50px;border-radius:6px 6px 0 0;
  transition:height 0.8s cubic-bezier(0.34,1.56,0.64,1);
  min-height:4px;
}
.bar-label{font-size:0.75rem;color:#888;}
.bar-count{font-size:0.9rem;font-weight:700;}

.leaderboard{margin-top:1.5rem;}
.lb-row{
  display:flex;align-items:center;gap:1rem;
  background:rgba(255,255,255,0.05);
  border-radius:12px;padding:0.8rem 1.2rem;
  margin-bottom:0.5rem;
}
.lb-rank{font-size:1.3rem;width:35px;text-align:center;}
.lb-name{flex:1;font-weight:700;}
.lb-score{color:#fff;font-weight:900;}

/* â”€â”€ Final â”€â”€ */
#final{display:none;text-align:center;}
.podium{
  display:flex;align-items:flex-end;justify-content:center;
  gap:0.5rem;margin:2rem 0;
}
.pod{
  display:flex;flex-direction:column;align-items:center;gap:0.5rem;
  padding:1rem;border-radius:12px;width:120px;
}
.pod-1{background:linear-gradient(180deg,rgba(245,166,35,0.3),rgba(245,166,35,0.1));height:160px;justify-content:flex-end;}
.pod-2{background:linear-gradient(180deg,rgba(192,192,192,0.3),rgba(192,192,192,0.1));height:130px;justify-content:flex-end;}
.pod-3{background:linear-gradient(180deg,rgba(205,127,50,0.3),rgba(205,127,50,0.1));height:100px;justify-content:flex-end;}
.pod-medal{font-size:2rem;}
.pod-name{font-weight:700;font-size:0.9rem;}
.pod-score{color:#fff;font-weight:900;}

.btn-new{
  background:#fff;
  color:#fff;font-size:1.1rem;margin-top:1rem;
}



/* QR canvas */
#qrLan, #qrNgrok{
  border-radius:12px;padding:8px;background:#111;
  display:inline-block;
}
#qrLan canvas, #qrNgrok canvas{display:block;}

/* Toasts */
.toast{
  position:fixed;top:1rem;left:50%;transform:translateX(-50%);
  background:#333;color:#fff;padding:0.8rem 1.5rem;border-radius:10px;
  font-size:1rem;z-index:9999;animation:fadeInOut 2.5s forwards;
}
@keyframes fadeInOut{0%{opacity:0;top:2rem;}10%{opacity:1;top:1rem;}80%{opacity:1;}100%{opacity:0;}}
</style>
</head>
<body>

<!-- Top Bar -->
<div class="topbar">
  <a href="/">ğŸ </a>
  <h1>ğŸ® QuizBlast â€” Ø§Ù„Ù…Ø¶ÙŠÙ</h1>
</div>

<!-- Host Login -->
<div id="hostLogin" style="display:none;position:fixed;inset:0;background:#0a0a0a;z-index:9999;align-items:center;justify-content:center;flex-direction:column">
  <div style="background:#1a1a1a;border:1px solid #2a2a2a;border-radius:8px;padding:2rem;width:90%;max-width:360px;text-align:center">
    <div style="font-size:2rem;margin-bottom:0.5rem">ğŸ”</div>
    <div style="font-family:'Oswald',sans-serif;font-size:1.2rem;letter-spacing:0.2em;margin-bottom:1.5rem">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¶ÙŠÙ</div>
    <input type="password" id="hostPassInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" maxlength="20"
      onkeydown="if(event.key==='Enter')checkHostPass()"
      style="width:100%;padding:0.9rem;border:1px solid #333;background:#111;color:#fff;border-radius:4px;font-size:1.1rem;text-align:center;margin-bottom:0.5rem;outline:none;font-family:Tajawal,sans-serif"/>
    <div id="hostPassError" style="color:#ef4444;font-size:0.8rem;margin-bottom:0.8rem;display:none">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙ„Ø· âŒ</div>
    <button onclick="checkHostPass()" style="width:100%;padding:0.9rem;background:#fff;color:#111;border:none;border-radius:4px;font-size:1rem;font-weight:700;cursor:pointer;font-family:Tajawal,sans-serif">Ø¯Ø®ÙˆÙ„ â—€</button>
  </div>
</div>

<!-- Builder -->
<div id="builder" class="main">
  <div class="quiz-title-wrap">
    <label class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</label>
    <input type="text" id="quizTitle" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§ ğŸŒ"/>
  </div>



  <div class="quiz-title-wrap" style="margin-bottom:1.5rem">
    <label class="label">Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¹Ø¨Ø©</label>
    <div style="display:flex;gap:0.8rem;margin-top:0.4rem">
      <button type="button" id="mode-solo" onclick="setGameMode('solo')"
        style="flex:1;padding:0.9rem;border:1px solid #fff;background:#fff;color:#111;border-radius:3px;cursor:pointer;font-family:Tajawal,sans-serif;font-size:1rem;font-weight:700;transition:all 0.15s">
        ğŸ‘¤ ÙØ±Ø¯ÙŠ
      </button>
      <button type="button" id="mode-team" onclick="setGameMode('team')"
        style="flex:1;padding:0.9rem;border:1px solid rgba(255,255,255,0.2);background:transparent;color:#fff;border-radius:3px;cursor:pointer;font-family:Tajawal,sans-serif;font-size:1rem;font-weight:700;transition:all 0.15s">
        ğŸ‘¥ ÙØ±ÙŠÙ‚
      </button>
    </div>
    <p id="modeHint" style="font-size:0.75rem;color:#555;margin-top:0.5rem;letter-spacing:0.1em">
      ÙƒÙ„ Ù„Ø§Ø¹Ø¨ ÙŠÙ„Ø¹Ø¨ Ù„Ø­Ø§Ù„Ù‡ â€” Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙØ±Ø¯ÙŠØ©
    </p>
  </div>

  <div id="questionsContainer"></div>

  <div style="display:flex;gap:0.8rem;margin-bottom:0.5rem">
    <button class="btn btn-add" onclick="addQuestion()" style="flex:1">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
    <button class="btn btn-add" onclick="openAIModal()" style="flex:1;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.3)">ğŸ¤– ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button>
  </div>
  <button class="btn btn-create" onclick="createRoom()">ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</button>
</div>

<!-- Edit Questions Modal -->
<div id="editModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:100;overflow-y:auto;padding:2rem">
  <div style="max-width:700px;margin:0 auto;background:#1a1a1a;border:1px solid #2a2a2a;border-radius:4px;padding:1.5rem">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
      <h2 style="font-size:1.2rem;letter-spacing:0.1em">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
      <button onclick="closeEditModal()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer">âœ•</button>
    </div>
    <div id="editQuestionsContainer"></div>
    <button class="btn btn-add" onclick="addEditQuestion()" style="margin-top:1rem">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
    <button class="btn btn-create" onclick="saveEdits()" style="margin-top:0.5rem">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
  </div>
</div>

<!-- Lobby -->
<div id="lobby" class="main">
  <div class="code-display">
    <p>Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</p>
    <div class="code-big" id="lobbyCode">------</div>
    <div style="margin-top:1rem;background:#111;display:inline-block;padding:8px;border-radius:12px">
      <img id="qrLanImg" width="180" height="180" style="display:block;border-radius:6px" alt="QR"/>
    </div>
    <p style="font-size:0.8rem;margin-top:0.5rem;opacity:0.6">Ø§Ù…Ø³Ø­ QR Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù…Ø¨Ø§Ø´Ø±Ø© ğŸ“±</p>
    <p style="font-size:0.75rem;margin-top:0.3rem;opacity:0.5" id="lobbyUrl"></p>
  </div>
  <button onclick="openEditModal()" style="background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);color:#fff;padding:0.6rem 1.5rem;border-radius:2px;cursor:pointer;font-family:Tajawal,sans-serif;font-size:0.9rem;letter-spacing:0.1em;margin-bottom:1rem">
    âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
  </button>
  <p id="playerCount" style="color:#888;margin:1rem 0">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</p>
  <div class="players-grid" id="playersList"></div>
  <button class="btn btn-start" id="startBtn" disabled onclick="startGame()">
    â–¶ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©
  </button>
</div>

<!-- Game Screen (Host View) -->
<div id="gamescreen">
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width:0%"></div>
  </div>
  <div class="game-container">
    <!-- Question phase -->
    <div id="questionPhase">
      <div class="question-header">
        <span class="q-counter" id="qCounter">Ø³Ø¤Ø§Ù„ 1 / 5</span>
        <div class="timer-circle" id="timerCircle">20</div>
      </div>
      <div class="question-box" id="qText">...</div>
      <img id="qImage" class="q-image" style="display:none"/>
      <div class="answers-host" id="answersHost"></div>
      <div class="answered-info" id="answeredInfo">Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª...</div>
      <!-- ØªÙ†Ø¨ÙŠÙ‡ ØºØ´ -->
      <div id="cheatAlert" style="display:none;background:rgba(239,68,68,0.15);border:1px solid #ef4444;border-radius:3px;padding:0.8rem 1rem;margin-top:0.8rem;text-align:right">
        <p id="cheatMsg" style="color:#ef4444;font-size:0.85rem;font-weight:700"></p>
        <p id="cheatPlayers" style="color:#aaa;font-size:0.78rem;margin-top:0.3rem"></p>
      </div>
      <div style="display:flex;gap:0.8rem;margin-top:1rem;flex-wrap:wrap">
        <button class="btn" id="stopTimerBtn" onclick="stopTimer()" 
          style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);flex:1;min-width:120px">
          â¸ Ø¥ÙŠÙ‚Ø§Ù
        </button>
        <button class="btn btn-next" id="showResultsBtn" onclick="hostShowResults()" style="flex:1;min-width:120px">
          ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        </button>
        <button class="btn" onclick="skipQuestion()" 
          style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);flex:1;min-width:120px">
          â­ ØªØ®Ø·ÙŠ
        </button>
      </div>
    </div>

    <!-- Results phase -->
    <div id="resultsPhase" style="display:none">
      <div class="results-overlay">
        <h2 style="text-align:center;margin-bottom:1rem">ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø¤Ø§Ù„</h2>
        <div class="answer-bars" id="answerBars"></div>
        <div class="leaderboard" id="leaderboard"></div>
      </div>
      <button class="btn btn-next" id="nextBtn">Ø§Ù„ØªØ§Ù„ÙŠ â¬…</button>
    </div>
  </div>
</div>

<!-- Final -->
<div id="final" class="main">
  <h1 style="font-size:2.5rem;margin-bottom:0.5rem">ğŸ† Ø§Ù„Ù†Ù‡Ø§ÙŠØ©!</h1>
  <p style="color:#888;margin-bottom:1rem">Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠÙˆÙ†</p>
  <div class="podium" id="podium"></div>
  <div id="fullFinal"></div>
  <button class="btn btn-new" onclick="location.href='/'">ğŸ”„ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
</div>

<script>
const socket = io();

// â”€â”€ Host Auth â”€â”€
function checkHostPass(){
  const pass = document.getElementById('hostPassInput').value.trim();
  if(pass === '120'){
    sessionStorage.setItem('hostAuth','120');
    document.getElementById('hostLogin').style.display = 'none';
  } else {
    document.getElementById('hostPassError').style.display = 'block';
    document.getElementById('hostPassInput').value = '';
    document.getElementById('hostPassInput').focus();
  }
}

// Show login if not authed
const __hostAuthed = sessionStorage.getItem('hostAuth') === '120';
if(!__hostAuthed){
  document.getElementById('hostLogin').style.display = 'flex';
} else {
  document.getElementById('hostLogin').style.display = 'none';
}
let roomCode = null;
let currentQuiz = null;
const COLORS = ['#fff','#aaa','#888','#bbb'];
const SYMBOLS = ['â–²','â™¦','â—','â˜…'];
let timerInterval = null;
let answeredCount = 0;
let totalPlayers = 0;
let lanUrl = '';
let adConfig = null;
let adTimer = null;
let currentQIndex = 0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QR & MODE TOGGLE
function generateQR(imgId, url){
  if(!url) return;
  const img = document.getElementById(imgId);
  if(!img) return;
  // Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠÙˆÙ„Ø¯ QR Ø¨Ù…ÙƒØªØ¨Ø© qrcode Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø©
  img.src = '/qr?url=' + encodeURIComponent(url);
  img.style.display = 'block';
  img.onerror = () => {
    img.style.display = 'none';
    img.insertAdjacentHTML('afterend','<p style="color:#fff;font-size:0.8rem">âš ï¸ ØªØ¹Ø°Ù‘Ø± ØªÙˆÙ„ÙŠØ¯ QR</p>');
  };
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gameMode = 'solo';
let teamCount = 2;
const TEAM_COLORS = [
  {name:'Ø£Ø­Ù…Ø±',   color:'#ef4444', emoji:'ğŸ”´'},
  {name:'Ø£Ø²Ø±Ù‚',   color:'#3b82f6', emoji:'ğŸ”µ'},
  {name:'Ø£Ø®Ø¶Ø±',   color:'#22c55e', emoji:'ğŸŸ¢'},
  {name:'Ø£ØµÙØ±',   color:'#eab308', emoji:'ğŸŸ¡'},
  {name:'Ø¨Ù†ÙØ³Ø¬ÙŠ', color:'#a855f7', emoji:'ğŸŸ£'},
  {name:'Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ',color:'#f97316', emoji:'ğŸŸ '},
  {name:'ÙˆØ±Ø¯ÙŠ',   color:'#ec4899', emoji:'ğŸ©·'},
  {name:'ÙÙŠØ±ÙˆØ²ÙŠ', color:'#06b6d4', emoji:'ğŸ©µ'},
  {name:'Ø¨ÙŠØ¬',    color:'#d97706', emoji:'ğŸŸ¤'},
  {name:'Ø±Ù…Ø§Ø¯ÙŠ',  color:'#6b7280', emoji:'âš«'},
];
let teamNames = ['ÙØ±ÙŠÙ‚ 1','ÙØ±ÙŠÙ‚ 2'];

function setTeamCount(n){
  teamCount = n;
  // update buttons style
  for(let i=2;i<=10;i++){
    const b = document.getElementById('tc-'+i);
    if(!b) continue;
    b.style.background = i===n ? '#fff' : 'transparent';
    b.style.color = i===n ? '#111' : '#fff';
    b.style.borderColor = i===n ? '#fff' : '#333';
  }
  // rebuild name inputs
  const container = document.getElementById('teamNameInputs');
  container.innerHTML = '';
  teamNames = [];
  for(let i=0;i<n;i++){
    const tc = TEAM_COLORS[i];
    teamNames.push(tc.name);
    const inp = document.createElement('input');
    inp.type = 'text';
    inp.value = tc.name;
    inp.placeholder = `Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ ${i+1}`;
    inp.style.cssText = `border-right:3px solid ${tc.color};padding-right:0.8rem`;
    inp.oninput = (e)=>{ teamNames[i] = e.target.value || tc.name; };
    container.appendChild(inp);
  }
}

function setGameMode(mode){
  gameMode = mode;
  const hints = {
    solo: 'ÙƒÙ„ Ù„Ø§Ø¹Ø¨ ÙŠÙ„Ø¹Ø¨ Ù„Ø­Ø§Ù„Ù‡ â€” Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙØ±Ø¯ÙŠØ©',
    team: 'Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙŠØ®ØªØ§Ø±ÙˆÙ† ÙØ±ÙŠÙ‚Ù‡Ù… â€” Ø§Ù„Ù†Ù‚Ø§Ø· ØªØªØ¬Ù…Ø¹ Ù„Ù„ÙØ±ÙŠÙ‚'
  };
  document.getElementById('modeHint').textContent = hints[mode];
  ['solo','team'].forEach(m => {
    const btn = document.getElementById('mode-'+m);
    if(m === mode){
      btn.style.background = '#fff'; btn.style.color = '#111'; btn.style.borderColor = '#fff';
    } else {
      btn.style.background = 'transparent'; btn.style.color = '#fff'; btn.style.borderColor = 'rgba(255,255,255,0.2)';
    }
  });
  document.getElementById('teamSetup').style.display = mode==='team' ? 'block' : 'none';
  if(mode==='team'){
    // init team count buttons
    const btns = document.getElementById('teamCountBtns');
    if(!btns.children.length){
      for(let i=2;i<=10;i++){
        const b = document.createElement('button');
        b.type='button'; b.id='tc-'+i; b.textContent=i;
        b.style.cssText=`padding:0.5rem 0.9rem;border:1px solid ${i===2?'#fff':'#333'};background:${i===2?'#fff':'transparent'};color:${i===2?'#111':'#fff'};border-radius:2px;cursor:pointer;font-family:Tajawal,sans-serif;font-size:0.9rem;transition:all 0.15s`;
        b.onclick=()=>setTeamCount(i);
        btns.appendChild(b);
      }
      setTeamCount(2);
    }
  }
}

let qCount = 0;
const questions = [];

function addQuestion(){
  const i = qCount++;
  questions.push({question:'',answers:['','','',''],correct:0,time:20,image:''});
  const div = document.createElement('div');
  div.className = 'question-card';
  div.id = `qcard-${i}`;
  div.innerHTML = `
    <div class="q-header">
      <div class="q-num">${i+1}</div>
      <button class="del-btn" onclick="removeQuestion(${i})">ğŸ—‘ Ø­Ø°Ù</button>
    </div>
    <label class="label">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
    <input type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..." oninput="questions[${i}].question=this.value"/>
    <label class="label">Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <input type="text" placeholder="https://..." oninput="questions[${i}].image=this.value"/>
    <label class="label">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª (Ø§Ø®ØªØ± Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ø§Ù„Ù†Ù‚Ø±)</label>
    <div class="answers-grid">
      ${[0,1,2,3].map(j=>`
        <div class="answer-wrap">
          <div class="answer-colors" style="background:${COLORS[j]};width:14px;height:14px;border-radius:3px;flex-shrink:0"></div>
          <input type="text" placeholder="Ø¥Ø¬Ø§Ø¨Ø© ${j+1}" oninput="questions[${i}].answers[${j}]=this.value"/>
          <input type="radio" name="correct-${i}" class="correct-radio"
            ${j===0?'checked':''}
            onchange="questions[${i}].correct=${j}" title="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©"/>
        </div>
      `).join('')}
    </div>
    <div class="time-wrap">
      <label>â± ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</label>
      <select onchange="questions[${i}].time=+this.value">
        <option value="5">5 Ø«ÙˆØ§Ù†ÙŠ</option>
        <option value="10">10 Ø«ÙˆØ§Ù†ÙŠ</option>
        <option value="15">15 Ø«Ø§Ù†ÙŠØ©</option>
        <option value="20" selected>20 Ø«Ø§Ù†ÙŠØ©</option>
        <option value="30">30 Ø«Ø§Ù†ÙŠØ©</option>
        <option value="45">45 Ø«Ø§Ù†ÙŠØ©</option>
        <option value="60">60 Ø«Ø§Ù†ÙŠØ©</option>
        <option value="90">90 Ø«Ø§Ù†ÙŠØ©</option>
        <option value="120">120 Ø«Ø§Ù†ÙŠØ©</option>
      </select>
    </div>
    <div id="adAfterWrap-${i}" style="margin-top:0.6rem;border:1px solid #2a2a2a;border-radius:2px;background:#0a0a0a">
      <label style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.7rem;cursor:pointer;font-size:0.82rem;color:#888">
        <input type="checkbox" id="adAfter-${i}" onchange="toggleAdInput(${i},this.checked)" style="width:auto;margin:0"/>
        ğŸŒ™ Ø§Ø¹Ø±Ø¶ Ø¥Ø¹Ù„Ø§Ù† Ø¨Ø¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„
      </label>
      <div id="adInput-${i}" style="display:none;padding:0 0.7rem 0.7rem">
        <input type="text" placeholder="Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ MP4..." oninput="questions[${i}].adVideoUrl=this.value"
          style="width:100%;padding:0.4rem 0.6rem;border:1px solid #333;background:#111;color:#fff;border-radius:2px;font-family:Tajawal,sans-serif;font-size:0.82rem;outline:none;margin-bottom:0.4rem"/>
        <input type="text" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" oninput="questions[${i}].adText=this.value"
          style="width:100%;padding:0.4rem 0.6rem;border:1px solid #333;background:#111;color:#fff;border-radius:2px;font-family:Tajawal,sans-serif;font-size:0.82rem;outline:none"/>
      </div>
    </div>
  `;
  document.getElementById('questionsContainer').appendChild(div);
}

function removeQuestion(i){
  const el = document.getElementById(`qcard-${i}`);
  if(el) el.remove();
  questions[i] = null;
}

function createRoom(){
  const title = document.getElementById('quizTitle').value.trim() || 'Ù…Ø³Ø§Ø¨Ù‚Ø©';
  // ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„ Ø³Ø¤Ø§Ù„: Ù†Øµ + Ø¥Ø¬Ø§Ø¨Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ + Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© Ù…Ø­Ø¯Ø¯Ø©
  const validQs = questions.filter(q => {
    if(!q) return false;
    if(!q.question || !q.question.trim()) return false;
    const filledAnswers = q.answers.filter(a => a && a.trim());
    if(filledAnswers.length < 2) return false;
    return true;
  });
  if(validQs.length === 0){
    toast('Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ø¹ Ø¥Ø¬Ø§Ø¨ØªÙŠÙ†!');
    return;
  }
  currentQuiz = {title, questions: validQs};
  adConfig = true; // ads configured per-question
  window._currentQuizQuestions = validQs;
  socket.emit('host:create', {quiz: currentQuiz, gameMode, teamNames: gameMode==='team'?teamNames:[]});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOCKET EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
socket.on('host:created', ({code, mode, teams})=>{
  roomCode = code;
  document.getElementById('builder').style.display = 'none';
  document.getElementById('lobby').style.display = 'block';
  document.getElementById('lobbyCode').textContent = code;

  // Ø£Ø¶Ù Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Ø§Ù„Ù€ URL
  const proto = location.protocol;
  const host = location.host;
  const teamsParam = (teams && teams.length) ? '&teams=' + encodeURIComponent(JSON.stringify(teams)) : '';
  lanUrl = `${proto}//${host}/play.html?code=${code}&mode=${mode||gameMode}${teamsParam}`;
  document.getElementById('lobbyUrl').textContent = lanUrl;

  // Ø£Ø¶Ù Ø¨Ø§Ø¯Ø¬ Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¹Ø¨Ø©
  const badge = document.createElement('p');
  badge.style.cssText = 'font-size:0.75rem;letter-spacing:0.2em;margin-top:0.5rem;color:#888';
  if((mode||gameMode)==='team' && teams && teams.length){
    badge.textContent = 'ğŸ‘¥ ÙˆØ¶Ø¹ Ø§Ù„ÙØ±ÙŠÙ‚ â€” ' + teams.map(t=>t.emoji+t.name).join(' ');
  } else {
    badge.textContent = (mode||gameMode)==='team' ? 'ğŸ‘¥ ÙˆØ¶Ø¹ Ø§Ù„ÙØ±ÙŠÙ‚' : 'ğŸ‘¤ ÙˆØ¶Ø¹ ÙØ±Ø¯ÙŠ';
  }
  document.getElementById('lobbyCode').insertAdjacentElement('afterend', badge);

  generateQR('qrLanImg', lanUrl);
});

socket.on('host:playerList', ({players})=>{
  totalPlayers = players.length;
  updateLobbyPlayers(players);
});

socket.on('room:update', ({players})=>{
  totalPlayers = players.length;
  updateLobbyPlayers(players);
});

socket.on('host:question', ({index,total,question,answers,correct,time,image})=>{
  currentQIndex = index;
  totalQuestions = total;
  answeredCount = 0;
  showGameScreen();
  document.getElementById('resultsPhase').style.display = 'none';
  document.getElementById('questionPhase').style.display = 'block';
  document.getElementById('qCounter').textContent = `Ø³Ø¤Ø§Ù„ ${index+1} / ${total}`;
  document.getElementById('qText').textContent = question;
  document.getElementById('progressFill').style.width = `${((index)/total)*100}%`;

  const img = document.getElementById('qImage');
  if(image){img.src=image;img.style.display='block';}else{img.style.display='none';}

  const grid = document.getElementById('answersHost');
  grid.innerHTML = answers.map((a,i)=>`
    <div class="ans-card" style="background:rgba(${hexToRgb(COLORS[i])},0.25);border:2px solid ${i===correct?'#0f9b8e':'transparent'}">
      <span class="ans-symbol">${SYMBOLS[i]}</span>
      <span class="ans-text">${a}</span>
      <span class="ans-count" id="acount-${i}">0</span>
    </div>
  `).join('');

  document.getElementById('answeredInfo').textContent = '0 / '+totalPlayers+' Ø£Ø¬Ø§Ø¨ÙˆØ§';
  // Ø§Ù†ØªØ¸Ø± 3 Ø«ÙˆØ§Ù†ÙŠ Ø±ÙŠØ«Ù…Ø§ ÙŠÙ†ØªÙ‡ÙŠ Ø¹Ø¯Ø§Ø¯ 3-2-1 Ø¹Ù†Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
  setTimeout(()=> startTimer(time), 3000);
});

socket.on('host:suspiciousActivity', ({message, players})=>{
  // Ø¥Ø¸Ù‡Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ ØºØ´
  const alert = document.getElementById('cheatAlert');
  if(alert){
    alert.style.display = 'block';
    document.getElementById('cheatMsg').textContent = message;
    document.getElementById('cheatPlayers').textContent = 'Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: ' + players.join('ØŒ ');
    setTimeout(()=>{ alert.style.display='none'; }, 6000);
  }
});

socket.on('host:answeredCount', ({count,total})=>{
  answeredCount = count;
  totalPlayers = total;
  document.getElementById('answeredInfo').textContent = `${count} / ${total} Ø£Ø¬Ø§Ø¨ÙˆØ§`;
});

socket.on('game:results', ({correct,stats,leaderboard,isLast})=>{
  clearInterval(timerInterval);
  document.getElementById('questionPhase').style.display = 'none';
  document.getElementById('resultsPhase').style.display = 'block';
  document.getElementById('leaderboard').style.display = 'none';

  // Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ØªØµÙˆÙŠØª - Kahoot style
  const PIE_COLORS = ['#e21b3c','#1368ce','#d89e00','#26890c'];
  const PIE_SHAPES = ['â–²','â—†','â—','âœ¦'];
  const total = stats.reduce((a,s)=>a+s.count,0)||1;
  document.getElementById('answerBars').innerHTML = `
    <div style="display:flex;gap:12px;justify-content:center;align-items:flex-end;height:160px;padding:0 1rem">
      ${stats.map((s,i)=>{
        const pct = Math.round((s.count/total)*100);
        const h = Math.max(40, Math.round((s.count/(Math.max(...stats.map(x=>x.count))||1))*130));
        const isCorrect = i===correct;
        return `
          <div style="display:flex;flex-direction:column;align-items:center;gap:6px;flex:1;animation:barUp 0.5s ease ${i*0.08}s both">
            <span style="font-family:'Oswald',sans-serif;font-size:1.3rem;font-weight:700;color:#fff">${s.count}</span>
            <div style="
              width:100%;height:${h}px;
              background:${PIE_COLORS[i]};
              border-radius:6px 6px 0 0;
              display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:8px;
              position:relative;
              box-shadow:${isCorrect?'0 0 20px '+PIE_COLORS[i]+'88':'none'};
              border-bottom:${isCorrect?'3px solid #fff':'3px solid rgba(0,0,0,0.3)'};
              opacity:${s.count===0&&!isCorrect?'0.4':'1'};
            ">
              <span style="font-size:1.1rem;color:rgba(255,255,255,0.9)">${PIE_SHAPES[i]}</span>
              ${isCorrect?'<span style="position:absolute;top:-28px;font-size:1.3rem">âœ“</span>':''}
            </div>
            <span style="font-size:0.78rem;color:${isCorrect?'#22c55e':'#666'};font-weight:700">${pct}%</span>
          </div>`;
      }).join('')}
    </div>
  `;

  // Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†: Ø§Ø¸Ù‡Ø± Ø§Ù„Ø³ÙƒÙˆØ±Ø¨ÙˆØ±Ø¯ØŒ ÙˆØ¨Ø¹Ø¯ 8 Ø«ÙˆØ§Ù†ÙŠ Ø§Ù†ØªÙ‚Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  setTimeout(()=>{
    const lbEl = document.getElementById('leaderboard');
    lbEl.style.display = 'block';
    lbEl.innerHTML = `
      <h3 style="text-align:center;margin:1.5rem 0 1rem;color:#fff;font-family:'Oswald',sans-serif;letter-spacing:0.2em;font-size:1.3rem">ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ†</h3>
      <div style="display:flex;flex-direction:column;gap:0.6rem;max-width:600px;margin:0 auto">
      ${leaderboard.slice(0,5).map((p,i)=>`
        <div style="display:flex;align-items:center;gap:0.8rem;background:${i===0?'rgba(255,215,0,0.12)':i===1?'rgba(192,192,192,0.08)':i===2?'rgba(205,127,50,0.08)':'rgba(255,255,255,0.04)'};border:1px solid ${i===0?'rgba(255,215,0,0.4)':'rgba(255,255,255,0.1)'};border-radius:8px;padding:1.1rem 1.4rem;animation:slideIn 0.4s ease ${i*0.1}s both">
          <span style="font-size:1.5rem;width:36px;text-align:center">${medals[i]||'#'+(i+1)}</span>
          <span style="flex:1;font-size:1.1rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.name}</span>
          <span style="font-family:'Oswald',sans-serif;font-size:1.5rem;font-weight:700;color:${i===0?'#ffd700':i===1?'#c0c0c0':i===2?'#cd7f32':'#fff'}">${p.score.toLocaleString()}</span>
        </div>
      `).join('')}
      </div>
    `;
    // Ø¹Ø¯Ø§Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ 8 Ø«ÙˆØ§Ù†ÙŠ
    let countdown = 8;
    const bar = document.createElement('div');
    bar.style.cssText = 'height:3px;background:#fff;width:100%;border-radius:2px;margin-top:1rem;transition:width 8s linear;';
    lbEl.appendChild(bar);
    setTimeout(()=>bar.style.width='0%', 50);
    const counter = document.createElement('div');
    counter.style.cssText = 'text-align:center;font-size:0.75rem;color:#555;letter-spacing:0.2em;margin-top:0.4rem';
    counter.textContent = `Ø§Ù„ØªØ§Ù„ÙŠ Ø®Ù„Ø§Ù„ ${countdown}Ø«`;
    lbEl.appendChild(counter);
    window._cdInt = setInterval(()=>{
      countdown--;
      counter.textContent = `Ø§Ù„ØªØ§Ù„ÙŠ Ø®Ù„Ø§Ù„ ${countdown}Ø«`;
      if(countdown <= 0){ clearInterval(window._cdInt); tryShowAdThenNext(isLast); }
    }, 1000);
    document.getElementById('nextBtn').onclick = ()=>{ clearInterval(window._cdInt); tryShowAdThenNext(isLast); };
  }, 2000);

  document.getElementById('nextBtn').textContent = isLast ? 'ğŸ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©' : 'Ø§Ù„ØªØ§Ù„ÙŠ â¬…';
});

socket.on('game:end', ({final, teamScores})=>{
  document.getElementById('gamescreen').style.display = 'none';
  document.getElementById('final').style.display = 'block';

  // Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ù„Ùˆ ÙˆØ¶Ø¹ ÙØ±ÙŠÙ‚
  if(teamScores && Object.keys(teamScores).length){
    const entries = Object.entries(teamScores).sort((a,b)=>b[1].score-a[1].score);
    const winnerEntry = entries[0];
    const teamBanner = document.createElement('div');
    teamBanner.style.cssText = 'text-align:center;padding:1rem;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:3px;margin-bottom:1rem';
    teamBanner.innerHTML = `
      <p style="font-size:0.75rem;letter-spacing:0.3em;color:#888;margin-bottom:0.8rem">Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ±Ù‚</p>
      <div style="display:flex;justify-content:center;gap:1rem;flex-wrap:wrap;margin-bottom:0.8rem">
        ${entries.map(([name,t],i)=>`
          <div style="text-align:center;padding:0.5rem 1rem;border:1px solid ${t.color};border-radius:3px;${i===0?'background:'+t.color+'22':''}">
            <div style="font-size:1.3rem;font-weight:900;color:${t.color}">${t.score.toLocaleString()}</div>
            <div style="font-size:0.75rem;color:#888">${t.emoji} ${name}</div>
          </div>
        `).join('')}
      </div>
      <p style="font-weight:700;color:${winnerEntry[1].color}">ğŸ† Ø§Ù„ÙØ§Ø¦Ø²: ${winnerEntry[1].emoji} ${winnerEntry[0]}</p>
    `;
    document.getElementById('final').insertBefore(teamBanner, document.getElementById('podium'));
  }

  const top3 = final.slice(0,3);
  const order = [1,0,2]; // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØµØ©: 2,1,3
  const heights = {0:'pod-1',1:'pod-2',2:'pod-3'};
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];

  document.getElementById('podium').innerHTML = order.map(rank=>{
    const p = top3[rank];
    if(!p) return '';
    return `
      <div class="pod ${heights[rank]}">
        <span class="pod-medal">${medals[rank]}</span>
        <span class="pod-name">${p.name}</span>
        <span class="pod-score">${p.score.toLocaleString()}</span>
      </div>
    `;
  }).join('');

  document.getElementById('fullFinal').innerHTML = `
    <div style="background:rgba(255,255,255,0.05);border-radius:16px;padding:1rem;margin-top:1rem">
      ${final.map(p=>`
        <div class="lb-row">
          <span class="lb-rank">#${p.rank}</span>
          <span class="lb-name">${p.name}</span>
          <span class="lb-score">${p.score.toLocaleString()}</span>
        </div>
      `).join('')}
    </div>
  `;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOST ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDIT QUESTIONS IN LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editQuestions = [];
let editQCount = 0;

function openEditModal(){
  // Ù†Ø³Ø® Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
  editQuestions = JSON.parse(JSON.stringify(currentQuiz.questions));
  editQCount = editQuestions.length;
  renderEditQuestions();
  document.getElementById('editModal').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeEditModal(){
  document.getElementById('editModal').style.display = 'none';
  document.body.style.overflow = '';
}

function renderEditQuestions(){
  const container = document.getElementById('editQuestionsContainer');
  container.innerHTML = '';
  editQuestions.forEach((q, i) => {
    if(!q) return;
    const div = document.createElement('div');
    div.className = 'question-card';
    div.id = `eqcard-${i}`;
    div.innerHTML = `
      <div class="q-header">
        <div class="q-num">${i+1}</div>
        <button class="del-btn" onclick="removeEditQuestion(${i})">ğŸ—‘ Ø­Ø°Ù</button>
      </div>
      <label class="label">Ø§Ù„Ø³Ø¤Ø§Ù„</label>
      <textarea rows="2" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„..." oninput="editQuestions[${i}].question=this.value">${q.question}</textarea>
      <div class="answers-grid">
        ${q.answers.map((a,j)=>`
          <div class="answer-input-wrap">
            <input type="radio" name="ecorrect-${i}" ${q.correct===j?'checked':''} onchange="editQuestions[${i}].correct=${j}"/>
            <input type="text" placeholder="Ø®ÙŠØ§Ø± ${j+1}" value="${a}"
              oninput="editQuestions[${i}].answers[${j}]=this.value"/>
          </div>
        `).join('')}
      </div>
      <div class="time-wrap">
        <label>â± ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</label>
        <select onchange="editQuestions[${i}].time=+this.value">
          ${[5,10,15,20,30,45,60,90,120].map(t=>`<option value="${t}" ${q.time==t?'selected':''}>${t} Ø«Ø§Ù†ÙŠØ©</option>`).join('')}
        </select>
      </div>
    `;
    container.appendChild(div);
  });
}

function addEditQuestion(){
  editQuestions.push({question:'',answers:['','','',''],correct:0,time:20});
  renderEditQuestions();
  // scroll to bottom
  document.getElementById('editQuestionsContainer').lastElementChild?.scrollIntoView({behavior:'smooth'});
}

function removeEditQuestion(i){
  editQuestions.splice(i, 1);
  renderEditQuestions();
}

function saveEdits(){
  const valid = editQuestions.filter(q => q && q.question.trim());
  if(valid.length === 0){ toast('Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!'); return; }
  currentQuiz.questions = valid;
  // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  closeEditModal();
  toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª â€” ' + valid.length + ' Ø³Ø¤Ø§Ù„');
}

function startGame(){
  if(!roomCode) return;
  socket.emit('host:start', {code: roomCode});
}

function skipQuestion(){
  if(confirm('ØªØ®Ø·ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')){
    clearInterval(timerInterval);
    socket.emit('host:skipQuestion', {code: roomCode});
  }
}

function stopTimer(){
  clearInterval(timerInterval);
  const el = document.getElementById('timerCircle');
  el.style.borderColor = '#888';
  el.style.color = '#888';
  document.getElementById('stopTimerBtn').disabled = true;
  document.getElementById('stopTimerBtn').style.opacity = '0.4';
}

function hostShowResults(){
  clearInterval(timerInterval);
  // Ø£ÙˆÙ‚Ù Ø£ÙŠ Ø¹Ø¯Ø§Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ù‚Ø¯ÙŠÙ…
  if(window._cdInt) clearInterval(window._cdInt);
  socket.emit('host:showResults', {code: roomCode});
}

function tryShowAdThenNext(isLast){
  const q = window._currentQuizQuestions && window._currentQuizQuestions[currentQIndex];
  if(q && q.showAdAfter && q.adVideoUrl && !isLast){
    adConfig = { videoUrl: q.adVideoUrl, mainText: q.adText || '', subText: '' };
    showAd(()=> hostNext());
  } else {
    hostNext();
  }
}

function hostNext(){
  socket.emit('host:next', {code: roomCode});
}

// â”€â”€ Ad System â”€â”€
// adConfig and adTimer declared above

function toggleAdInput(i, checked){
  questions[i].showAdAfter = checked;
  const el = document.getElementById('adInput-'+i);
  if(el) el.style.display = checked ? 'block' : 'none';
}



function showAd(onDone){ window._adOnDone = onDone;
  const overlay = document.getElementById('adOverlay');
  overlay.style.display = 'flex';
  document.getElementById('adText').textContent = adConfig.mainText || '';
  document.getElementById('adSubText').textContent = adConfig.subText || '';
  const video = document.getElementById('adVideo');
  const src = document.getElementById('adVideoSrc');
  src.src = adConfig.videoUrl || '';
  video.load();
  video.onerror = ()=>{ clearInterval(adTimer); closeAd(onDone); };
  video.play().catch(()=>{ setTimeout(()=>closeAd(onDone), 500); });
  let t = 15;
  const bar = document.getElementById('adBar');
  const counter = document.getElementById('adCounter');
  bar.style.transition = 'none'; bar.style.width = '100%';
  video.onloadedmetadata = ()=>{
    t = Math.ceil(video.duration) || 15;
    bar.style.transition = 'none'; bar.style.width = '100%';
    setTimeout(()=>{ bar.style.transition = `width ${t}s linear`; bar.style.width = '0%'; }, 50);
    counter.textContent = `ÙŠØ³ØªÙ…Ø± ${t} Ø«Ø§Ù†ÙŠØ©`;
  };
  setTimeout(()=>{ bar.style.transition = `width ${t}s linear`; bar.style.width = '0%'; }, 50);
  counter.textContent = `ÙŠØ³ØªÙ…Ø± ${t} Ø«Ø§Ù†ÙŠØ©`;
  clearInterval(adTimer);
  video.onended = ()=>{ clearInterval(adTimer); closeAd(onDone); };
  adTimer = setInterval(()=>{
    t--;
    counter.textContent = t > 0 ? `ÙŠØ³ØªÙ…Ø± ${t} Ø«Ø§Ù†ÙŠØ©` : '';
    if(t <= 0){ clearInterval(adTimer); closeAd(onDone); }
  }, 1000);
}

function closeAd(onDone){
  clearInterval(adTimer);
  document.getElementById('adOverlay').style.display = 'none';
  if(typeof onDone === 'function') onDone();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateLobbyPlayers(players){
  const grid = document.getElementById('playersList');
  // Group by team
  const teamA = players.filter(p=>p.team==='A');
  const teamB = players.filter(p=>p.team==='B');
  const noTeam = players.filter(p=>!p.team);
  
  let html = '';
  if(teamA.length || teamB.length){
    if(teamA.length) html += `<div style="margin-bottom:0.5rem"><span style="color:#ff6b6b;font-size:0.75rem;letter-spacing:0.2em">ğŸ”´ Ø§Ù„ÙØ±ÙŠÙ‚ A (${teamA.length})</span><div style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.3rem">${teamA.map(p=>playerChip(p)).join('')}</div></div>`;
    if(teamB.length) html += `<div style="margin-bottom:0.5rem"><span style="color:#6bb5ff;font-size:0.75rem;letter-spacing:0.2em">ğŸ”µ Ø§Ù„ÙØ±ÙŠÙ‚ B (${teamB.length})</span><div style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.3rem">${teamB.map(p=>playerChip(p)).join('')}</div></div>`;
    if(noTeam.length) html += `<div><span style="color:#888;font-size:0.75rem;letter-spacing:0.2em">Ø¨Ø¯ÙˆÙ† ÙØ±ÙŠÙ‚</span><div style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.3rem">${noTeam.map(p=>playerChip(p)).join('')}</div></div>`;
  } else {
    html = `<div style="display:flex;flex-wrap:wrap;gap:0.4rem">${players.map(p=>playerChip(p)).join('')}</div>`;
  }
  grid.innerHTML = html;
  document.getElementById('playerCount').textContent = `${players.length} Ù„Ø§Ø¹Ø¨ Ù…Ù†Ø¶Ù…`;
  const btn = document.getElementById('startBtn');
  btn.disabled = players.length < 1;
}

function playerChip(p){
  return `<div class="player-chip" style="display:flex;align-items:center;gap:0.4rem;padding:0.4rem 0.7rem">
    <span>ğŸ‘¤ ${p.name}</span>
    <button onclick="renamePlayer('${p.socketId}','${p.name}')" 
      style="background:none;border:none;cursor:pointer;color:#888;font-size:0.8rem;padding:0" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…">âœï¸</button>
    <button onclick="kickPlayer('${p.socketId}')" 
      style="background:none;border:none;cursor:pointer;color:#ff4444;font-size:0.8rem;padding:0" title="Ø·Ø±Ø¯">âœ•</button>
  </div>`;
}

function renamePlayer(socketId, currentName){
  const newName = prompt(`ØªØºÙŠÙŠØ± Ø§Ø³Ù… "${currentName}" Ø¥Ù„Ù‰:`, currentName);
  if(newName && newName.trim() && newName !== currentName){
    socket.emit('host:renamePlayer', {code: roomCode, socketId, newName: newName.trim()});
  }
}

function kickPlayer(socketId){
  if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ø±Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ØŸ')){
    socket.emit('host:kickPlayer', {code: roomCode, socketId});
  }
}

function showGameScreen(){
  document.getElementById('lobby').style.display = 'none';
  document.getElementById('gamescreen').style.display = 'block';
}

// ØµÙˆØª Ø§Ù„Ø¯Ù‚Ø§Øª
let audioCtx = null;
function playTick(isLast){
  try {
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = isLast ? 880 : 660;
    osc.type = 'sine';
    gain.gain.setValueAtTime(0.35, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
    osc.start(audioCtx.currentTime);
    osc.stop(audioCtx.currentTime + 0.1);
  } catch(e){}
}

function startTimer(sec){
  // reset stop button
  const sb = document.getElementById('stopTimerBtn');
  if(sb){sb.disabled=false;sb.style.opacity='1';}
  let t = sec;
  const el = document.getElementById('timerCircle');
  el.textContent = t;
  el.style.borderColor = '#fff';
  el.style.color = '#fff';
  clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    t--;
    el.textContent = t;
    if(t <= 5 && t > 0){ el.style.borderColor='#ff4444';el.style.color='#ff4444'; playTick(t===1); }
    if(t <= 0){
      clearInterval(timerInterval);
      hostShowResults();
    }
  },1000);
}

function hexToRgb(hex){
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return `${r},${g},${b}`;
}

function toast(msg){
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),2600);
}

// Start with one question
addQuestion();
</script>
<!-- Ad Settings (shown in builder) -->

<!-- Ad Overlay (Video) -->
<div id="adOverlay" style="display:none;position:fixed;inset:0;background:#000;z-index:300;flex-direction:column;align-items:center;justify-content:center;text-align:center;">
  <div style="width:100%;max-width:900px;padding:1rem">
    <div id="adText" style="font-family:'Tajawal',sans-serif;font-size:1.4rem;font-weight:900;color:#fff;margin-bottom:0.3rem"></div>
    <div id="adSubText" style="font-size:0.85rem;color:#888;margin-bottom:0.8rem"></div>
    <video id="adVideo" style="width:100%;max-height:75vh;border-radius:4px;display:block;background:#000" autoplay playsinline>
      <source id="adVideoSrc" src="" type="video/mp4"/>
    </video>
    <div style="width:200px;margin:0.8rem auto 0">
      <div style="height:3px;background:#222;border-radius:2px;overflow:hidden">
        <div id="adBar" style="height:100%;background:#fff;width:100%;border-radius:2px;transition:width linear"></div>
      </div>
      <div id="adCounter" style="font-size:0.7rem;color:#444;margin-top:0.3rem;letter-spacing:0.15em"></div>
    </div>
    <button onclick="closeAd(window._adOnDone)" style="margin-top:0.6rem;background:none;border:1px solid #222;color:#444;padding:0.4rem 1rem;border-radius:2px;font-family:Tajawal,sans-serif;cursor:pointer;font-size:0.72rem">ØªØ®Ø·ÙŠ â­</button>
  </div>
</div>

<!-- AI Generate Modal -->
<div id="aiModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:200;align-items:center;justify-content:center;">
  <div style="background:#1a1a1a;border:1px solid #2a2a2a;border-radius:4px;padding:2rem;width:100%;max-width:480px;position:relative">
    <button onclick="closeAIModal()" style="position:absolute;top:1rem;left:1rem;background:none;border:none;color:#888;font-size:1.3rem;cursor:pointer">âœ•</button>
    <h3 style="font-family:'Oswald',sans-serif;letter-spacing:0.2em;margin-bottom:1.5rem;font-size:1.1rem">ğŸ¤– ØªÙˆÙ„ÙŠØ¯ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
    
    <label class="label">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
    <input type="text" id="aiTopic" placeholder="Ù…Ø«Ø§Ù„: ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¨ØŒ ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù…ØŒ Ø¬ØºØ±Ø§ÙÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…..." 
      style="width:100%;padding:0.8rem;border:1px solid #333;background:#111;color:#fff;border-radius:2px;font-family:Tajawal,sans-serif;font-size:0.95rem;margin-bottom:1rem;outline:none"/>
    
    <label class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
    <div style="display:flex;gap:0.5rem;margin-bottom:1.5rem" id="aiCountBtns">
      <button onclick="setAICount(5)"  id="aic-5"  style="flex:1;padding:0.6rem;border:1px solid #fff;background:#fff;color:#111;border-radius:2px;cursor:pointer;font-family:Tajawal,sans-serif">5</button>
      <button onclick="setAICount(10)" id="aic-10" style="flex:1;padding:0.6rem;border:1px solid #333;background:transparent;color:#fff;border-radius:2px;cursor:pointer;font-family:Tajawal,sans-serif">10</button>
      <button onclick="setAICount(15)" id="aic-15" style="flex:1;padding:0.6rem;border:1px solid #333;background:transparent;color:#fff;border-radius:2px;cursor:pointer;font-family:Tajawal,sans-serif">15</button>
      <button onclick="setAICount(20)" id="aic-20" style="flex:1;padding:0.6rem;border:1px solid #333;background:transparent;color:#fff;border-radius:2px;cursor:pointer;font-family:Tajawal,sans-serif">20</button>
    </div>

    <label class="label">ØµØ¹ÙˆØ¨Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
    <div style="display:flex;gap:0.5rem;margin-bottom:1.5rem" id="aiDiffBtns">
      <button onclick="setAIDiff('Ø³Ù‡Ù„')"   id="aid-Ø³Ù‡Ù„"   style="flex:1;padding:0.6rem;border:1px solid #333;background:transparent;color:#fff;border-radius:2px;cursor:pointer;font-family:Tajawal,sans-serif">Ø³Ù‡Ù„</button>
      <button onclick="setAIDiff('Ù…ØªÙˆØ³Ø·')" id="aid-Ù…ØªÙˆØ³Ø·" style="flex:1;padding:0.6rem;border:1px solid #fff;background:#fff;color:#111;border-radius:2px;cursor:pointer;font-family:Tajawal,sans-serif">Ù…ØªÙˆØ³Ø·</button>
      <button onclick="setAIDiff('ØµØ¹Ø¨')"   id="aid-ØµØ¹Ø¨"   style="flex:1;padding:0.6rem;border:1px solid #333;background:transparent;color:#fff;border-radius:2px;cursor:pointer;font-family:Tajawal,sans-serif">ØµØ¹Ø¨</button>
    </div>


    <button id="aiGenerateBtn" onclick="generateQuestions()" class="btn btn-create" style="margin-bottom:0">
      âœ¨ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    </button>
    
    <div id="aiStatus" style="display:none;text-align:center;margin-top:1rem;color:#888;font-size:0.85rem;letter-spacing:0.1em">
      <div style="display:inline-block;animation:spin 1s linear infinite;font-size:1.5rem">âŸ³</div>
      <div id="aiStatusText" style="margin-top:0.5rem">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...</div>
    </div>
  </div>
</div>

<style>
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
@keyframes slideIn{from{transform:translateX(60px);opacity:0;}to{transform:translateX(0);opacity:1;}}
@keyframes barUp{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
</style>

<script>
let aiCount = 5;
let aiDiff = 'Ù…ØªÙˆØ³Ø·';

function openAIModal(){
  document.getElementById('aiModal').style.display = 'flex';

  setTimeout(()=>document.getElementById('aiTopic').focus(), 100);
}
function closeAIModal(){
  document.getElementById('aiModal').style.display = 'none';
  document.getElementById('aiStatus').style.display = 'none';
  document.getElementById('aiGenerateBtn').disabled = false;
}
function setAICount(n){
  aiCount = n;
  [5,10,15,20].forEach(x=>{
    const b = document.getElementById('aic-'+x);
    b.style.background = x===n ? '#fff' : 'transparent';
    b.style.color = x===n ? '#111' : '#fff';
    b.style.borderColor = x===n ? '#fff' : '#333';
  });
}
function setAIDiff(d){
  aiDiff = d;
  ['Ø³Ù‡Ù„','Ù…ØªÙˆØ³Ø·','ØµØ¹Ø¨'].forEach(x=>{
    const b = document.getElementById('aid-'+x);
    b.style.background = x===d ? '#fff' : 'transparent';
    b.style.color = x===d ? '#111' : '#fff';
    b.style.borderColor = x===d ? '#fff' : '#333';
  });
}

async function generateQuestions(){
  const topic = document.getElementById('aiTopic').value.trim();
  if(!topic){ alert('Ø§ÙƒØªØ¨ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹'); return; }

  document.getElementById('aiGenerateBtn').disabled = true;
  document.getElementById('aiStatus').style.display = 'block';
  document.getElementById('aiStatusText').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯... Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ 10-20 Ø«Ø§Ù†ÙŠØ©';

  const prompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø³Ø¦Ù„Ø© Ù…Ø³Ø§Ø¨Ù‚Ø©. 
Ø£Ù†Ø´Ø¦ ${aiCount} Ø³Ø¤Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¹Ù† Ù…ÙˆØ¶ÙˆØ¹: "${topic}"
Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©: ${aiDiff}

Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ù‡Ù…Ø©:
- ÙƒÙ„ Ø³Ø¤Ø§Ù„ Ù„Ù‡ 4 Ø®ÙŠØ§Ø±Ø§Øª ÙÙ‚Ø·
- Ø®ÙŠØ§Ø± ÙˆØ§Ø­Ø¯ ØµØ­ÙŠØ­ ÙÙ‚Ø·
- Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ø­Ø¯Ø¯Ø©
- ØªÙ†ÙˆØ¹ ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©

Ø£Ø¬Ø¨ Ø¨Ù€ JSON ÙÙ‚Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´ÙƒÙ„ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ:
[
  {
    "question": "Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„",
    "answers": ["Ø®ÙŠØ§Ø±1", "Ø®ÙŠØ§Ø±2", "Ø®ÙŠØ§Ø±3", "Ø®ÙŠØ§Ø±4"],
    "correct": 0
  }
]
Ø­ÙŠØ« "correct" Ù‡Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (0-3)`;

  try {
    // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    let apiKey = '';
    try {
      const keyRes = await fetch('/ai-key');
      if(keyRes.ok){ const d = await keyRes.json(); apiKey = d.key; }
    } catch(e){}
    if(!apiKey){
      document.getElementById('aiStatusText').textContent = 'âŒ Ù„Ù… ÙŠÙØ¶Ø¨Ø· COHERE_API_KEY Ø¹Ù„Ù‰ Railway â€” Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª';
      document.getElementById('aiGenerateBtn').disabled = false;
      return;
    }

    const response = await fetch('https://api.cohere.com/v2/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + apiKey,
        'X-Client-Name': 'alpha-quiz'
      },
      body: JSON.stringify({
        model: 'command-r-plus-08-2024',
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 4000,
        temperature: 0.7
      })
    });

    if(!response.ok){
      const err = await response.json();
      throw new Error(err.message || 'Ø®Ø·Ø£ ÙÙŠ API');
    }
    const data = await response.json();
    const text = data.message.content[0].text;
    
    // parse JSON
    const jsonMatch = text.match(/\[[\s\S]*\]/);
    if(!jsonMatch) throw new Error('ØªØ¹Ø°Ø± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
    const generated = JSON.parse(jsonMatch[0]);

    // Add to questions list
    generated.forEach(q => {
      const idx = qCount++;
      questions.push({
        question: q.question,
        answers: q.answers,
        correct: q.correct,
        time: 20,
        image: ''
      });
      const div = document.createElement('div');
      div.className = 'question-card';
      div.id = `qcard-${idx}`;
      div.innerHTML = buildQuestionHTML(idx, q.question, q.answers, q.correct, 20);
      document.getElementById('questionsContainer').appendChild(div);
    });

    closeAIModal();
    // scroll to last question
    document.getElementById('questionsContainer').lastElementChild?.scrollIntoView({behavior:'smooth'});
    
    // show success toast
    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:#22c55e;color:#fff;padding:0.8rem 1.5rem;border-radius:2px;font-family:Tajawal,sans-serif;z-index:999;font-size:0.9rem;letter-spacing:0.1em';
    toast.textContent = `âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ ${generated.length} Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!`;
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(), 3000);

  } catch(e) {
    document.getElementById('aiStatusText').textContent = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + e.message;
    document.getElementById('aiGenerateBtn').disabled = false;
  }
}

function buildQuestionHTML(i, questionText, answersArr, correctIdx, time, imageUrl){
  return `
    <div class="q-header">
      <div class="q-num">${i+1}</div>
      <button class="del-btn" onclick="removeQuestion(${i})">ğŸ—‘ Ø­Ø°Ù</button>
    </div>
    <label class="label">Ø§Ù„Ø³Ø¤Ø§Ù„</label>
    <textarea rows="2" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„..." oninput="questions[${i}].question=this.value">${questionText}</textarea>
    <div class="answers-grid">
      ${answersArr.map((a,j)=>`
        <div class="answer-input-wrap">
          <input type="radio" name="correct-${i}" ${correctIdx===j?'checked':''} onchange="questions[${i}].correct=${j}"/>
          <input type="text" placeholder="Ø®ÙŠØ§Ø± ${j+1}" value="${a.replace(/"/g,'&quot;')}"
            oninput="questions[${i}].answers[${j}]=this.value"/>
        </div>
      `).join('')}
    </div>
    <div class="time-wrap">
      <label>â± ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</label>
      <select onchange="questions[${i}].time=+this.value">
        ${[5,10,15,20,30,45,60,90,120].map(t=>`<option value="${t}" ${time==t?'selected':''}>${t} Ø«Ø§Ù†ÙŠØ©</option>`).join('')}
      </select>
    </div>
    <div class="time-wrap" style="margin-top:0.4rem">
      <label>ğŸ–¼ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
      <input type="text" placeholder="https://..." value="${imageUrl||''}"
        oninput="questions[${i}].image=this.value"
        style="flex:1;padding:0.4rem 0.6rem;border:1px solid #333;background:#0a0a0a;color:#fff;border-radius:2px;font-family:Tajawal,sans-serif;font-size:0.82rem;outline:none"/>
    </div>
    <div id="adAfterWrap-${i}" style="margin-top:0.6rem;border:1px solid #2a2a2a;border-radius:2px;background:#0a0a0a">
      <label style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0.6rem;cursor:pointer;font-size:0.78rem;color:#888">
        <input type="checkbox" id="adAfter-${i}" onchange="toggleAdInput(${i},this.checked)" style="width:auto;margin:0"/>
        ğŸŒ™ Ø§Ø¹Ø±Ø¶ Ø¥Ø¹Ù„Ø§Ù† Ø¨Ø¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„
      </label>
      <div id="adInput-${i}" style="display:none;padding:0 0.6rem 0.6rem">
        <input type="text" placeholder="Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ MP4..." oninput="questions[${i}].adVideoUrl=this.value"
          style="width:100%;padding:0.4rem 0.6rem;border:1px solid #333;background:#111;color:#fff;border-radius:2px;font-family:Tajawal,sans-serif;font-size:0.82rem;outline:none;margin-bottom:0.3rem"/>
        <input type="text" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" oninput="questions[${i}].adText=this.value"
          style="width:100%;padding:0.4rem 0.6rem;border:1px solid #333;background:#111;color:#fff;border-radius:2px;font-family:Tajawal,sans-serif;font-size:0.82rem;outline:none"/>
      </div>
    </div>
  `;
}
</script>
</body>
</html>
